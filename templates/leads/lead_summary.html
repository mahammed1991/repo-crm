{% extends 'layouts/main.html' %}

{% load staticfiles %}
{% load static %}
{% load question_list_tags %}

{% block title %}
Regalix Google Portal
{% endblock title %}

{% block main_css %}

{% endblock main_css %}

{% block content %}
<!-- content-region -->
  <section class="content-region">
    <div class="container-fluid">
      <h1>Leads Summary</h1>
      <div class="row">
        <div class="col-xs-6 col-sm-4 col-md-2 placeholder">
          <div class="circle_green">{{lead_status_dict.implemented }}</div>
          <div class="sum-lbl">Wins</div>
        </div>
        <div class="col-xs-6 col-sm-4 col-md-2 placeholder">
          <div class="circle_red">{{lead_status_dict.in_queue}}</div>
          <div class="sum-lbl">In Queue</div>
        </div>
        <div class="col-xs-6 col-sm-4 col-md-2 placeholder">
          <div class="circle_blue">{{lead_status_dict.attempting_contact}}</div>
          <div class="sum-lbl">Attempting Contact</div>
        </div>
        <div class="col-xs-6 col-sm-4 col-md-2 placeholder">
          <div class="circle_yellow">{{lead_status_dict.in_progress}}</div>
          <div class="sum-lbl">In Progress</span> </div>
        </div>
        <div class="col-xs-6 col-sm-4 col-md-2 placeholder">
          <div class="circle">{{lead_status_dict.in_active}}</div>
          <div class="sum-lbl">Inactive</div>
        </div>
        <div class="col-xs-6 col-sm-4 col-md-2 placeholder">
          <div class="circle_black">{{lead_status_dict.total_leads}}</div>
          <div class="sum-lbl">Total</div>
        </div>
      </div>
      <h1 class="lead_status">Leads Status</h1>
      <div class="row">
          <div class="col-xs-12 col-sm-12 col-md-5">
            <ul class="pagination">
              <li><a class="tag" href="#" id='all'>All</a></li>
              <li><a class="page" href="#" id='Inactive'>Inactive</a></li>
              <li><a class="page" href="#" id='InQueue'>In Queue</a></li>
              <li><a class="page" href="#" id='AttemptingContact'>Attempting Contact</a></li>
              <li><a class="page" href="#" id='InProgress' >In Progress </a></li>
              <li><a class="page" href="#" id='Implemented'>Implemented</a></li>
            </ul>
          </div>
          <div class="col-xs-6 col-sm-6 col-md-2">
            <div class="has-feedback">
               <input type="text" class="form-control input-sm" id="inputValidation" placeholder="Search" onkeyup="filter(this, 'Leads')"/>
              <span class="search-icon"><i class="fa fa-search" /></i></span> </div>
          </div>
          <div class="col-xs-6 col-sm-6 col-md-2 pull-right">            
              <ul class="filer-area">
                <li class="lbl">Sort by: </li>
                <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Recent <i class="fa fa-angle-down"></i></a>
                  <ul class="dropdown-menu light" role="menu">
                    <li><a href="#" id="RecentHeader">Recent</a></li>
                    <li><a href="#" id='CodeTypeHeader'>Code Type</a></li>
                    <li><a href="#" id="statusHeader">Status</a></li>
                  </ul>
                  </li>
              </ul>
            </div>
          </div>
      </span>
      <div class="row">
      <div class="table-responsive col-xs-12 col-sm-12 col-md-12">
        <table class="table status-table tablesorter" id='Leads'>
          <thead>
            <tr  class="table_bg">
              <th class="hidden-xs hidden-sm nthchild">No.</th>
              <th class="hidden-xs hidden-sm nthchild1">Advertiser</th>
              <th class="nthchild2">CID </th>
              <th class="hidden-xs hidden-sm nthchild3" id="CodeTypeRow">Code Type </th>
              <th class="hidden-xs hidden-sm nthchild3">Google Rep</th>
              <th class="hidden-xs hidden-sm nthchild3">Regalix Rep</th>
              <th class="hidden-xs hidden-sm nthchild3" id="RecentRow">Date Created</th>
              <th class="hidden-xs hidden-sm nthchild3" >Appointment Time</th>
              <th class="hidden-xs hidden-sm nthchild3">Date of Installation</th>
              <th class="hidden-xs hidden-sm nthchild8">Google Comments</th>
              <th class="hidden-xs hidden-sm nthchild8">Regalix Comments</th>
              <th class="nthchild3" id='StatusRow'>Status </th>
              <th class="nthchild11">Action</th>
            </tr>
            </thead>
            <tbody>
            {% for l in leads %}

                      {% if l.lead_status == 'Implemented' %}
                      <tr class='status-implemented implemented searchable'>
                        <td class="hidden-xs hidden-sm"><span class="status-bor-color">{{forloop.counter}}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'In Active' %}
                      <tr class='status-inactive inactive searchable'>
                        <td class="hidden-xs hidden-sm"><span class="status-bor-color">{{forloop.counter}}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'In Progress' %}
                      <tr class="status-inpro  inprogress searchable">
                        <td class="hidden-xs hidden-sm"><span class="status-bor-color">{{forloop.counter}}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'Attempting Contact' %}
                      <tr class='status-attm-contact attemptingcontact searchable'>
                        <td class="hidden-xs hidden-sm"><span class="status-bor-color">{{forloop.counter}}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'In Queue' %}
                      <tr class='status-inq inqueue searchable'>
                        <td class="hidden-xs hidden-sm"><span class="status-bor-color">{{forloop.counter}}</span></td>
                      {% endif %}
                      <td class="hidden-xs hidden-sm">{{ l.company }}</td>
                      <td>{{ l.customer_id }}</td>
                      <td class="hidden-xs hidden-sm">{{ l.type_1 }}</td>
                      <td class="hidden-xs hidden-sm">{{ l.google_rep_name }}</td>
                      <td class="hidden-xs hidden-sm">{{ l.lead_owner_name }}</td>
                      <td class="hidden-xs hidden-sm">{{ l.created_date |date:"m/d/Y" }}</td>
                      <td class="hidden-xs hidden-sm">{{ l.appointment_date |date:"m/d/Y [h:m]" }}</td>
                      <td class="hidden-xs hidden-sm">{{ l.date_of_installation |date:"m/d/Y" }}</td>
                      {% if l.google_comment  %}
                        <td class="hidden-xs hidden-sm comments-container"><p>{{ l.google_comment | truncatechars:100 }}</p>
                            <p class="comments-full"><img class="left-arrow" src="{%static 'images/comments-left-arrow.png' %}"> {{ l.google_comment}}</p> </td>
                      {% else %}
                        <td class="hidden-xs hidden-sm comments-container"><p></p>
                        </td>
                      {% endif %}
                      {% if l.regalix_comment  %}
                          <td class="hidden-xs hidden-sm comments-container"><p>{{ l.regalix_comment | truncatechars:100 }}</p>
                            <p class="comments-full"><img class="left-arrow" src="{%static 'images/comments-left-arrow.png' %}"> {{ l.regalix_comment}}</p> </td>
                      {% else %}
                          <td class="hidden-xs hidden-sm comments-container"><p></p>
                            </td>
                      {% endif %}
                     
                      {% if l.lead_status == 'Implemented' %}
                        <td><span class="status-txt-color">{{ l.lead_status }}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'In Active'%}
                        <td><span class="status-txt-color">{{ l.lead_status }}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'In Progress' %}
                        <td><span class="status-txt-color">{{ l.lead_status }}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'Attempting Contact' %}
                        <td><span class="status-txt-color">{{ l.lead_status }}</span></td>
                      {% endif %}
                      {% if l.lead_status == 'In Queue' %}
                        <td><span class="status-txt-color">{{ l.lead_status }}</span></td>
                      {% endif %}
                      <td ><a href="#" title="Ping Status" class="action-item" data-toggle="modal" data-target="#pingModal" onclick='chat({{l.id}})' id="lead_id-{{l.id}}"><i class="fa fa-comments"></i></a> <a href="#" title="Write Feedback" class="action-item fb" data-toggle="modal" data-target="#feedbackModal"><i class="fa fa-pencil-square" onclick='feedbackBycid({{l.id}})'></i></td>
                      
                    </tr>
                    
                {% endfor %}
              </tbody>
        </table>
        <div class="span4"></div>
        <div class="span4"><img src="{% static 'images/pre_loading.png' %}" alt=" " class="center-block"/></div>
        <div class="span4"></div>
      </div>
      </span>
    </div>
  </section>
  <!-- content-region ends --> 

  
<!-- feedback modal -->
<div class="modal" id="feedbackModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog ping-snippet">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i aria-hidden="true" class="fa fa-times-circle"></i></button>
        <h4 class="modal-title" id="myModalLabel">Feedback</h4>
      </div>
      <div class="modal-body">
         <input type="text" class="form-control error-box" id="feedbackTitle" placeholder="Feedback Title">
           <select class="form-control" id="feedbackType">
              <option>Feedback Type</option>
              <option value="Technical - Incorrect code installed">Technical - Incorrect code installed</option>
              <option value="Technical - Code installed on wrong page">Technical - Code installed on wrong page</option>
              <option value="Communication - Rude rep">Communication - Rude rep</option>
              <option value="Communication - Unable to understand rep">Communication - Unable to understand rep</option>
              <option value="Operations - Missed appointments">Operations - Missed appointments</option>
              <option value="Operations - No follow up">Operations - No follow up</option>
              <option value="Operations - Incorrect information provided">Operations - Incorrect information provided</option>
          </select>
          <textarea class="form-control" placeholder="Comments" id='comments'></textarea>
       
      </div>
      <div class="modal-footer">

        <div class="btn-group">
            <button class="btn std-btn" id='SubmitFeedback'>Submit</button>
            <button class="btn std-btn grayed" data-dismiss="modal" id='closeFeedbcak'>Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- feedback modal ends -->
{% endblock content %}
  {% block model_popup %}
      <!-- modal -->
      <div class="modal" id="pingModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog ping-snippet">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i aria-hidden="true" class="fa fa-times-circle"></i></button>
              <h4 class="modal-title" id="myModalLabel">History</h4>
            </div>
            <div class="modal-body">
              
            </div>
            <div class="modal-footer">
                <input  type="textarea" class="form-control send-txt" placeholder="Send a messege" id='message'>
                <button type="button" class="btn send-btn" id='submitmsg'><i class="fa fa-plus"></i></button>
            </div>
        </div>
      </div>
      <!-- modal ends -->
  {% endblock model_popup %}
{% block main_js %}
<script src="{% static 'js/lead_summary.js' %}"></script>
<script type="text/javascript">
$(document).ready(function(){
    window.lead_id = '{{lead_id|safe}}';
    if(window.lead_id != 'None'){
      $("#lead_id-"+ window.lead_id).trigger("click");
      chat(window.lead_id);
    }
});
window.lead_id = '';

function feedbackBycid(lead_id){
  window.lead_id = lead_id
}
/* pin chat */
var lead_owner_email = ''
var lead_owner_name = ''
var weekday = new Array("Sun","Mon","Tue","Wed","Thu","Fri","Sat")
var currentTime = new Date();
var day = currentTime.getDay()
var hour = currentTime.getHours()
var min = currentTime.getMinutes()
currentDayTime=''
if (hour >= 12){
  hour = hour - 12
  currentDayTime = weekday[day]+ ', ' + ' ' + hour + ' : ' + min + ' PM'
}else{
  currentDayTime = weekday[day]+ ', ' + ' ' + hour + ' : ' + min + ' AM'
}

function chat(lead_id){
    window.lead_id = lead_id
    dataString = {'lead_id': window.lead_id}
    $.ajax({
          url: "/leads/get-chat",
          data: dataString,
          type: 'GET',
          dataType: "json",
          success: function(data) {
                console.log(data)
                 setChat(data)       
          }
          
        }); 

}

function setChat(chatmessages){
    $('.modal-body').html('')
    for(i=0; i < chatmessages.length; i +=1){
      if (chatmessages[i].user_id === '{{user.email}}'){
            $('.modal-body').append(  '<div class=" ping-copy out-msg">' +
                                      '<img src="{{request.session.profile_image}}" class="chatter-img">'+
                                      '<div class="chat-msg">'+
                                      '<img src="{%static 'images/chat-out-img.png' %}">'+
                                      '<p>'+ chatmessages[i].message +' </p><div class="chat-date">'+ chatmessages[i].created_date +'</div></div></div>');
                 
            }else{

              $('.modal-body').append(  '<div class=" ping-copy in-msg">' +
                                      '<img src="'+chatmessages[i].image_url+'?sz=32" class="chatter-img">'+
                                      '<div class="chat-msg">'+
                                      '<img src="{%static 'images/chat-in-img.png' %}">'+
                                      '<p>'+ chatmessages[i].message +' </p><div class="chat-date">'+ chatmessages[i].created_date +'</div></div></div>')
            }
    }
}

var counter = true;
$('#submitmsg').click(function(){
  msg = $('#message').val()
  $('#message').val('')
  console.log(window.lead_id)
   dataString = {'msg': msg, 'lead_id': window.lead_id};
   if (msg != ''){
     $.ajax({
          url: "/leads/create-chat",
          data: dataString,
          type: 'GET',
          dataType: "json",
          success: function(data) {
            setChat(data);
          }
        }); 
   
   }else{
    alert('please Enter some text msg')
   }
  
})

$("#message").keypress(function(event) {
    if (event.which == 13) {
        event.preventDefault();

        $("#submitmsg").trigger("click");
    }
});
</script>

{% endblock main_js %}
