{% extends 'layouts/main.html' %}

{% load staticfiles %}
{% block title %}
  Argos Management
{% endblock title %}

 {% block main_css %}
 <style type="text/css">
 body{
  overflow-x:hidden;
 }
.argos_filter{
    margin-left: 4%;
}
 .dataTables_length{
    margin-left: 4%;
}
  table th{
    text-align: center !important;
  }
 </style>
 <link rel="stylesheet" href="{% static 'css/webapp/vendor/jquery.dataTables.min.css' %}">
 {% endblock main_css %}

 {% block content %}
 <section class="content-region inner-page">
   <div class="container" style="">
    <button id="argos_entry_button" class="btn std-btn sm-btn" style="float:right;margin-top: 1%;margin-right: 2%;line-height: 90%;">+ Add</button>
    <h2>Argos Management</h2>
   </div>

   <div id="argos_entry_form" class="container-fluid" style="display:none; margin-bottom:30px;">
        <div class="row">

          <div class="col-md-4">
            <label for="name">CID :</label>
            <input type="text" class="form-control" id="cid_field" name="" placeholder="CID" style="">
          </div>
          <div class="col-md-4">
                  <label for="name">Rep Name :</label>
            <input type="text" class="form-control" id="rep_name" name="" placeholder="Rep Name" style="">
          </div>
          <div class="col-md-4">
                  <label for="name">Products Count :</label>
            <input type="number" min="0" class="form-control" id="product_count" name="" placeholder="Products Count" style="">
          </div>
        </div>
    <div class="row">
        <div class="col-md-12">
            <label for="name">Attributes :</label>
        <textarea type="text" class="form-control" id="attributes" name="" placeholder="Attributese area" style=""></textarea>
        </div>
    </div>
    <div class="row">
          <div class="col-md-5">
          </div>
      <div class="col-md-4">
          <label for="name"></label><br>
          <button id="argos_submit_button" class="btn std-btn sm-btn" style="" >SUBMIT</button>
      </div>
      <div class="col-md-3">
      </div>
    </div>
   </div>

   <!-- TABLE START FROM HERE -->
    <div id="argos_wrapper" class="dataTables_wrapper no-footer" style="margin-bottom: 1%;">
    
                    <table id="argos" class="display" cellspacing="0" width="92%" style="text-align:center">
                        <thead>
                            <tr >
                                <th>CID</th>
                                <th>Rep Name</th>
                                <th>Products Count</th>
                                <th >Attributes</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th style="width:94px !important;">Action</th>
                            </tr>
              </thead>
                        <tbody id="argos_tbody"></tbody>
                    </table>
                
    </div>


 </section>
  {% endblock content %}

  {% block main_js %}
<script src="{% static 'js/reports/jquery.min.js' %}"></script>
<script src="{% static 'js/reports/moment.min.js' %}"></script>
<script src="{% static 'js/webapp/vendor/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'js/jquery.datetimepicker.full.js' %}"></script>
<script type="text/javascript" src="{% static 'js/reports/jquery-ui.min.js' %}"></script>
<script type="text/javascript">


function startFunction(id){
    var time = new Date(); // for now
    var hr = time.getHours();
    var ampm = hr < 12 ? "am" : "pm";
    time=moment(time).format('HH:MM:SS');
  if($('#statusButton'+id).val() === "Start Time" ){
     $("#edit_link"+id).remove('a[href^="' +id+ '"]').remove("");
    document.getElementById('start_time_field'+id).innerHTML = time +" "+ampm;
    document.getElementById('statusButton'+id).value= "End Time";
    document.getElementById('statusButton'+id).style.color = "Blue"
}else if($('#statusButton'+id).val() === "End Time" ){
      document.getElementById('end_time_field'+id).innerHTML = time +" "+ ampm;
    document.getElementById('statusButton'+id).disabled= true;
    document.getElementById('statusButton'+id).value= "Time Stopped";
    document.getElementById('statusButton'+id).style.color = "Red"
}
}


  $(document).ready(function(){
    function updateArgosData(){
        $('#argos').DataTable({
            "ajax": {
                "url": "/leads/get-argos/",
                'type':'GET',
                "dataSrc": function(json) {
      
                    json = json['data']
                   
                    for(var i=0; i<json.length; i++){
                      
                        var start_time = json[i].start_time;
                        if(start_time === null){
                        start_time_value = '<span id="start_time_field'+json[i].id+'">-</span>' 
                        }else{
                          start_time_value = '<span id="start_time_field'+json[i].id+'">'+start_time+'</span>'
                        }
                        var end_time = json[i].end_time;
                        if(end_time === null){
                        end_time_value = '<span id="end_time_field'+json[i].id+'">-</span>' 
                        }else{
                          end_time_value = '<span id="end_time_field'+json[i].id+'">'+end_time+'</span>'
                        }

                        var end_time = json[i].end_time;
                        if(end_time === null)
                            end_time = "-";

                        json[i][0] = json[i].lid;
                        json[i][1] = json[i].rep_name;
                        json[i][2] = json[i].products_count;
                        json[i][3] = json[i].attributes;
                        json[i][4] = start_time_value;
                        json[i][5] = end_time_value;

                        json[i][6] ='<input id="statusButton'+json[i].id+'"onclick="startFunction('+json[i].id+')" type="button" value="Start Time" style="color:green;"> <a title="Edit" id="edit_link'+json[i].id+'" class="edit" href="#"><span class="glyphicon glyphicon-edit"></span></a>'
                                      
                    }
                    return json;
                }
            },
            columnDefs: [
                {targets: [ 1 ], orderData: [ 1 ]},
                {bSortable: false,targets: [ 0, 3, 6 ]},
                { "width": "10%", "targets": 0 },
                { "width": "20%", "targets": 1 },
                { "width": "20%", "targets": 2 },
                { "width": "30%", "targets": 3 },
                { "width": "10%", "targets": 4 },
                { "width": "10%", "targets": 5 },
                { "width": "10%", "targets": 6 },
            ],
            order: [[ 1, "asc" ]],
            "bDestroy": true,
        });
    }

    updateArgosData();

  });

        $("#argos_entry_button").click(function(){
        if($("#argos_entry_form").is(":visible"))
            $("#argos_entry_button").text("+ Add");
        else
            $("#argos_entry_button").text("Close");

         $("#argos_entry_form").toggle();
    });

       
      


  /*form validation code*/
  valid = true;
  $("#argos_submit_button").click(function(){
    var cid_field = $("#cid_field").val().trim();
    var rep_name = $("#rep_name").val().trim();
    var product_count = $("#product_count").val().trim();
    var cidFormat = /^\d{3}-\d{3}-\d{4}$/;
         
      if(cid_field === ""){
        $("#cid_field").addClass('error-box');
        valid = false;
      }else{
            /* cid formate validation*/
            var res = cidFormat.test(cid_field);
            if(res){
              $("#cid_field").removeClass('error-box');
              valid = true;
            }
              else{
              alert("CID-formate XXX-XXX-XXXX does not match");
                $("#cid_field").addClass('error-box');
                 valid = false;
            }
      }
          
      if(rep_name === ""){
        $("#rep_name").addClass('error-box');
        valid = false;
      }else{
        $("#rep_name").removeClass('error-box');
        valid = true;
      }

      if(product_count === ""){
        $("#product_count").addClass('error-box');
        valid = false;
      }else{
        $("#product_count").removeClass('error-box');
        valid = true;
      }
      var attributes = $('#attributes').val();
      if(valid){
        var jsonData = {cid:cid_field,rep_name:rep_name,product_count:product_count,attributes:attributes};
        $.ajax({
          type: "POST",
          url: '/leads/argos-management/',
          data: JSON.stringify(jsonData),
          contentType: "application/json; charset=utf-8",
          traditional: true,
          success: function (data) {
          },
          error: function(data){
              alert("Something went wrong, please try after some time");
          }
        });
      }

  })

  </script>
  {% endblock %}

