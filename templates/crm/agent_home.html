<!DOCTYPE html>
<html lang="en">

{% extends 'layouts/main.html' %}
{% load static %}
{% load staticfiles %}

{% block title %}
  All Leads
{% endblock title %}

{% block main_css %}
  <link href="{% static 'css/crm/style.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'css/font-awesome.min.css' %}" rel="stylesheet" type="text/css">
    <style>
        .alert {
            padding: 19px 15px;
            color: #fefefe;
            position: relative;
            font: 20px/20px Museo300Regular, Helvetica, Arial, sans-serif;
        }
        .alert .msg { padding: 0 20px 0 40px;}
        .info-box {		background: #4D7DBE  no-repeat 14px 14px;}
        .pagination {
            display: inline-block;
            padding-left: 0;
            margin: 20px 0;
            border-radius: 4px;
        }

        .pagination>li {
            display: inline;
        }

        .pagination>li:first-child>a, .pagination>li:first-child>span {
            margin-left: 0;
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }

        .pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hover {
          z-index: 3;
          color: #fff;
          cursor: default;
          background-color: #337ab7;
          border-color: #337ab7;
      }

      .pagination>li>a, .pagination>li>span {
          position: relative;
          float: left;
          padding: 6px 12px;
          margin-left: -1px;
          line-height: 1.42857143;
          color: #337ab7;
          text-decoration: none;
          background-color: #fff;
          border: 1px solid #ddd;
      }

      .pagination>li>a:hover, .pagination>li>span:focus, .pagination>li>span:hover {
          z-index: 2;
          color: #23527c;
          background-color: #eee;
          border-color: #ddd;
      }

      .pagination>li:last-child>a, .pagination>li:last-child>span {
          border-top-right-radius: 4px;
          border-bottom-right-radius: 4px;
      }
      </style>
{% endblock main_css %}

  {% block content %}
  <body>
        
        <section class="top-margin wfm">
       		<div class="container-fluid" style="max-width:100%;">
            	<div class="white-section">
                	<div class="blue-bg">
                    <div class="col-sm-12">
                      <div class="blue-padding-20">
                        <div class="row">
                            <div class="col-sm-4">
                              <label for="status">Status</label>
                               <select class="form-control bgicon" id='status'>
                               <option>Select</option>
                                 {% if lead_status %}
                                  {% for status in lead_status %}
                                   <option>{{status}}</option>
                                   {% endfor %}
                                 {% endif %}
                               </select>
                             </div>
                             <div class="col-sm-4">
                               <label for="status">Sub Status</label>
                               <select class="form-control bgicon" id='sub_status'>
                               </select>
                             </div> 
                             <div class="col-sm-1"><p>OR</p></div> 
                             <div class="col-sm-3">
                                <label for="fresh-appointment">Fresh Appointment</label>
                                <select class="form-control bgicon" id='appointment' >
                                   <option>Select</option>
                                   <option>Without Appointment</option>
                                   <option>30 minutes</option>
                                   <option>1 hour</option>
                                   <option>Today</option>
                                   <option>Tomorrow</option>
                                   <option>This week</option>
                                </select> 
                             </div>
                            </div>
                          </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                	<div class="padding-20 wfm-body-table">
                    	<table class="table table-bordered"> 
                        	<thead> 
                            	<tr> 
                                    <th>CID </th> 
                                    <th>Company</th> 
                                    <th>Customer Name</th> 
                                    <th>Appointment time</th> 
                                    <th>Phone No</th> 
                                    <th>Additional Ph No</th> 
                                    <th>Web Master No.</th> 
                                    <th>Location</th> 
                                  </tr>
                             </thead> 
                             <tbody> 
                             </tbody> 
                     	</table>
                    </div>
                    <div id="data" class="padding-20 wfm-body-table" style="display:none;margin-top: -479px;"></div>
                </div>
               <div style="margin-bottom: 10px;">
                  <ul class="pagination" id="pagination">
                    
                  </ul>
                </div>
            </div>
        </section>

  

  </body>
{% endblock content %}

{% block main_js %}
<script src="{% static 'js/reports/jquery.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/mini_crm_js/appointment_chrome_notification.js' %}"></script>
<script type="text/javascript">
  var pageNum = 1;
  function call_crm_management(freshAppointment){
      status = $('#status').val()
      sub_status = $('#sub_status').val()
      appointment = $('#appointment').val()
      data = {'status':status, 'sub_status':sub_status}
      if(freshAppointment){
        data = {'appointment': appointment}
        $('#status').val('Select')
        $('#sub_status').html('')
        lead_sub_status = lead_data_status.lead_status_sub_status_mapping.TAG[$('#status').val()]
        if (lead_sub_status){
          for(var i=0;i<lead_sub_status.length;i++){
            $('#sub_status').append("<option>"+ lead_sub_status[i] + "</option>")                          
          }
        }
        else{
          $('#sub_status').append("<option>Select</option>")
        }
        $('#sub_status').val('Select')
      }
      else{
        $('#appointment').val('Select')
      }

      data['page'] = pageNum;

      $.ajax({
              type: "GET",
              url: '/crm/myleads/',
              data: data,
              success: function(response) {
                      leads_count = response['leads_count']
                      if (leads_count > 10){
                        numOfPages = Math.ceil(leads_count/10);
                        formPagination(numOfPages);
                        }
                      else{
                        formPagination(1);
                      }
                      if (response['leads_list'].length) {
                        $('table').show();
                        $('#data').hide(); 
                        $('tbody').html('')
                        for(var i=0;i<response['leads_list'].length;i++){
                          $('tbody').append('<tr> <td><a onclick="addURL(this)" href="/crm/lead-details/' + response['leads_list'][i]['id'] + '/'+ response['leads_list'][i]['sf_lead_id'] + '" target="_blank">'+ response['leads_list'][i]['customer_id'] + '</a> </td>'+ "<td>"+response['leads_list'][i]['company'] + "</td> <td>"+response['leads_list'][i]['customer_name']+"</td> <td>"+response['leads_list'][i]['appointment_time']  + "</td> <td> " + response['leads_list'][i]['phone']  +"</td> <td> " + response['leads_list'][i]['phone_optional'] + "</td> <td> " + response['leads_list'][i]['web_master_no']  +"</td> <td>" + response['leads_list'][i]['location'] +"</td></tr>")                          
                        }
                      }
                      else{
                        $('#data').html('<div  id="no-leads-msg">'+
                                        '<div class="container-fluid" style="margin-top:15%;">'+
                                        '<div class="info-box alert"><div class="msg">'+
                                        '<strong> Info : </strong> <i><b>There are no leads assigned to you or there are no records for the sort criteria, '+
                                        'please contact your TL/WFM.</b></i></div></div></div></div>');
                        $('#data').show(); 
                        $('table').hide();
                      }
              },
      });    
  }

  function addURL(element)
  {
    //var type = $('#process option:selected').text().replace(" ","");
    process_type = 'TAG'
    $(element).attr('href', function() {
          var url = this.href;
          if(url.includes(process_type))
          {
            return this.href;
          }
          else{
            return this.href + '/' + process_type;
          }
    });
  }

  function populate_sub_status(){
    status = $('#status').val()
    $('#sub_status').html('')
    lead_sub_status = lead_data_status.lead_status_sub_status_mapping.TAG[status]
    if (lead_sub_status){
      for(var i=0;i<lead_sub_status.length;i++){
        $('#sub_status').append("<option>"+ lead_sub_status[i] + "</option>")                          
      }
    }
    else{
      $('#sub_status').append("<option>Select</option>")
    }
    call_crm_management(false);    
  }

  $('#status').on('change',function(){
    pageNum = 1;
    populate_sub_status()
  })

  $('#sub_status').on('change',function(){
    pageNum = 1;
    call_crm_management(false);
  })

  $('#appointment').on('change',function(){
    pageNum = 1;
    appointment = $('#appointment').val()
    if (appointment != 'Select'){
      call_crm_management(true);
    }
    else{
      call_crm_management(false);
    }

  })

  var formPagination = function(numOfPages){
    var ulEle = $("#pagination");
    ulEle.html('');
    
    if(pageNum < 2)
      ulEle.append("<li><a class='paged disabled' href='#'>«</a></li>");
    else
      ulEle.append("<li><a class='paged' href='#'>«</a></li>");

    for(i=1; i<= numOfPages; i++){
      if(pageNum == i)
        ulEle.append("<li><a class='paged active'href='#' style='background-color: #4CAF50;'>"+i+"</a></li>");
      else
        ulEle.append("<li><a class='paged' href='#'>"+i+"</a></li>");
    }

    if(pageNum == numOfPages)
      ulEle.append("<li><a class='paged disabled' href='#'>«</a></li>");
    else
      ulEle.append("<li><a class='paged ' href='#'>»</a></li>");
  }

  $("body").on('click', '.paged', function(e){
      e.preventDefault();
      var page = $(this).text();
      console.log(pageNum,page)
      if(pageNum > 0 || parseInt(page)){
        if(page === "«")
          pageNum -= 1;
        else if(page === "»")
          pageNum += 1;
        else
          pageNum = parseInt(page);
        console.log(pageNum,page,'2')
      }
      appointment = $('#appointment').val()
      if (appointment != 'Select'){
        call_crm_management(true);
      }
      else{
        call_crm_management(false);
      }
  });

$(document).ready(function() {
  lead_data = '{{lead_status_sub_status_mapping}}'
  lead_data_status = JSON.parse(lead_data.replace(/&quot;/g,'"'));
  lead_status = $('#status').val('In Queue')
  populate_sub_status();
});
</script>
{% endblock main_js %}