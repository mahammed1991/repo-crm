<!DOCTYPE html>
<html lang="en">

{% extends 'layouts/main.html' %}
{% load static %}
{% load staticfiles %}

{% block title %}
  All Leads
{% endblock title %}

{% block main_css %}
  <style type="text/css"></style>
  <link href="{% static 'css/crm/style.css' %}" rel="stylesheet" type="text/css">
    <link href="{% static 'css/font-awesome.min.css' %}" rel="stylesheet" type="text/css">
{% endblock main_css %}

  {% block content %}
  <body>
        
        <section class="top-margin wfm">
       		<div class="container-fluid" style="max-width:100%;">
            	<div class="white-section">
                	<div class="blue-bg">
                    <div class="col-sm-12">
                      <div class="blue-padding-20">
                        <div class="row">
                            <div class="col-sm-4">
                              <label for="status">Status</label>
                               <select class="form-control bgicon" id='status'>
                               <option>Select</option>
                                 {% if lead_status %}
                                  {% for status in lead_status %}
                                   <option>{{status}}</option>
                                   {% endfor %}
                                 {% endif %}
                               </select>
                             </div>
                             <div class="col-sm-4">
                               <label for="status">Sub Status</label>
                               <select class="form-control bgicon" id='sub_status'>
                               </select>
                             </div> 
                             <div class="col-sm-1"><p>OR</p></div> 
                             <div class="col-sm-3">
                                <label for="fresh-appointment">Fresh Appointment</label>
                                <select class="form-control bgicon" id='appointment' >
                                   <option>Select</option>
                                   <option>30 minutes</option>
                                   <option>1 hour</option>
                                   <option>Today</option>
                                   <option>Tomorrow</option>
                                   <option>This week</option>
                                </select> 
                             </div>
                            </div>
                          </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                	<div class="padding-20 wfm-body-table">
                    	<table class="table table-bordered"> 
                        	<thead> 
                            	<tr> 
                                    <th>CID </th> 
                                    <th>Company</th> 
                                    <th>Customer Name</th> 
                                    <th>Appointment time</th> 
                                    <th>Phone No</th> 
                                    <th>Additional Ph No</th> 
                                    <th>Web Master No.</th> 
                                    <th>Location</th> 
                                  </tr>
                             </thead> 
                             <tbody> 
                             </tbody> 
                     	</table>
                    </div>
                </div>
            </div>
        </section>

  

  </body>
{% endblock content %}

{% block main_js %}
<script src="{% static 'js/reports/jquery.min.js' %}"></script>
<script type="text/javascript">
  function call_crm_management(freshAppointment){
      status = $('#status').val()
      sub_status = $('#sub_status').val()
      appointment = $('#appointment').val()
      data = {'status':status, 'sub_status':sub_status}
      if(freshAppointment){
        data = {'appointment': appointment}
        $('#status').val('Select')
        $('#sub_status').html('')
        lead_sub_status = lead_data_status.lead_status_sub_status_mapping.TAG[$('#status').val()]
        if (lead_sub_status){
          for(var i=0;i<lead_sub_status.length;i++){
            $('#sub_status').append("<option>"+ lead_sub_status[i] + "</option>")                          
          }
        }
        else{
          $('#sub_status').append("<option>Select</option>")
        }
        $('#sub_status').val('Select')
      }
      else{
        $('#appointment').val('Select')
      }
      $.ajax({
              type: "GET",
              url: '/crm/myleads/',
              data: data,
              success: function(response) {
                      if (response.length) {
                        $('tbody').html('')
                        for(var i=0;i<response.length;i++){
                          $('tbody').append('<tr> <td><a onclick="addURL(this)" href="/crm/lead-details/' + response[i]['id'] + '/'+ response[i]['sf_lead_id'] + '" target="_blank">'+ response[i]['customer_id'] + '</a> </td>'+ "<td>"+response[i]['company'] + "</td> <td>"+response[i]['customer_name']+"</td> <td>"+response[i]['appointment_time']  + "</td> <td> " + response[i]['phone']  +"</td> <td> " + response[i]['phone_optional'] + "</td> <td> " + response[i]['web_master_no']  +"</td> <td>" + response[i]['location'] +"</td></tr>")                          
                        }
                      }
                      else{
                        $('tbody').html('')
                      }
              },
      });    
  }

  function addURL(element)
  {
    //var type = $('#process option:selected').text().replace(" ","");
    process_type = 'TAG'
    $(element).attr('href', function() {
          var url = this.href;
          if(url.includes(process_type))
          {
            return this.href;
          }
          else{
            return this.href + '/' + process_type;
          }
    });
  }

  function populate_sub_status(){
    status = $('#status').val()
    $('#sub_status').html('')
    lead_sub_status = lead_data_status.lead_status_sub_status_mapping.TAG[status]
    if (lead_sub_status){
      for(var i=0;i<lead_sub_status.length;i++){
        $('#sub_status').append("<option>"+ lead_sub_status[i] + "</option>")                          
      }
    }
    else{
      $('#sub_status').append("<option>Select</option>")
    }
    call_crm_management(false);    
  }

  $('#status').on('change',function(){
    populate_sub_status()
  })

  $('#sub_status').on('change',function(){
    call_crm_management(false);
  })

  $('#appointment').on('change',function(){
    appointment = $('#appointment').val()
    if (appointment != 'Select'){
      call_crm_management(true);
    }
    else{
      call_crm_management(false);
    }

  })

$(document).ready(function() {
  lead_data = '{{lead_status_sub_status_mapping}}'
  lead_data_status = JSON.parse(lead_data.replace(/&quot;/g,'"'));
  lead_status = $('#status').val('In Queue')
  populate_sub_status();
});
</script>
{% endblock main_js %}