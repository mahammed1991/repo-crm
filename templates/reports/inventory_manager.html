{% extends 'layouts/main.html' %}

{% load staticfiles %}

{% block title %}
Inventory
{% endblock title %}
{% block main_css %}
    <link rel="stylesheet" href="{% static 'css/webapp/vendor/jquery.dataTables.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/representative/jquery.datetimepicker.css' %}">
{% endblock main_css %}

{% block content %}

<div class="wrapper">
<!-- content-region -->
    <section class="content-region inner-page">
        <div class="container-fluid" style="max-width: 98%;">
                <button id="add_emp" class="btn std-btn sm-btn" style="float:right;margin-top: 1%;margin-right: 10%;line-height: 90%;" >+ Add</button>
                <h2>Chromebook Inventory</h2>
                <div id="emp_entry" class="row" style="margin-bottom:1%;display:none;">
                    {% csrf_token %}
                    <div style="margin-bottom: 1%;margin-left: 1.2%;font-weight: bold;">
                        <span id="msg-container"></span>
                    </div>
                    <div class="col-md-2">
                        <label for="emp-id">Employee Id</label>
                        <input type="text" class="form-control emp" id="emp-id" name="emp-id" placeholder="Employee ID" style="height:40px;">
                    </div>
                   <div class="col-md-2">
                       <label for="name">Employee Name</label>
                        <input type="text" class="form-control emp" id="name" name="name" placeholder="Name" style="height:40px;">
                    </div>
                   <div class="col-md-2">
                        <label for="ldap">Employee Ldap</label>
                        <input type="text" class="form-control emp" id="ldap" name="ldap" placeholder="LDAP" style="height:40px;">
                    </div>
                   <div class="col-md-2">
                       <label for="alias">Alias</label>
                       <input type="text" class="form-control emp" id="alias" name="alias" placeholder="Alias" style="height:40px;">
                    </div>
                   <div class="col-md-2">
                        <label for="project">Project</label>
                        <select type="text" class="form-control bgicon dropdown" id="project" name="project" style="height:40px;">
                            <option value="select project">Select project</option>
                            <option value="Google Portal">Google Portal</option>
                            <option value="Picasso Audits">Picasso Audits</option>
                            <option value="Picasso Builds">Picasso Builds</option>
                            <option value="RLSA">RLSA</option>
                            <option value="Shopping">Shopping</option>
                            <option value="Tag">Tag</option>
                        </select>
                    </div>
                   <div class="col-md-2">
                       <label for="device-type">Device Type</label>
                       <input type="text" class="form-control emp" id="device-type" name="device-type" placeholder="Device Type" style="height:40px;">
                    </div>
                   <div class="col-md-2">
                       <label for="mac-id">MAC Id</label>
                       <input type="text" class="form-control emp" id="mac-id" name="mac-id" placeholder="MAC-ID" style="height:40px;">
                    </div>
                   <div class="col-md-2">
                       <label for="employee-status">Employee Status</label>
                       <select type="text" class="form-control bgicon dropdown" id="employee-status" name="employee-status" style="height:40px;">
                           <option value="active"> Active </option>
                       </select>
                   </div>
                   <div class="col-md-2">
                       <label for="device-status">Device Status</label>
                        <select type="text" class="form-control bgicon dropdown" id="device-status" style="height:40px;" name="device-status">
                            <option value="assigned"> Assigned </option>
                        </select>
                   </div>
                   <div class="col-md-2">
                       <label for="issued-on">Issued On</label>
                       <input type="text" class="issued-on form-control emp" id="issued-on" name="issued-on" placeholder="Issued Date" style="height:40px;">
                   </div>
                   <div class="col-md-2">
                        <button id="submit" class="btn std-btn sm-btn" style="margin-top: 12%;height:40px;">Submit</button>
                   </div>

                </div>
                <div id="inventory_wrapper" class="dataTables_wrapper no-footer" style="margin-bottom: 1%;">
                    <table id="inventory" class="display" cellspacing="0" width="100%">
                        <thead>
                            <tr role="row">
                                <th>Emp Id</th>
                                <th>Name</th>
                                <th>LDAP</th>
                                <th>Alias</th>
                                <th>Project</th>
                                <th>Device type</th>
                                <th>MAC ID</th>
                                <th>Employee Status</th>
                                <th>Device Status</th>
                                <th>Issued on</th>
                                <!--th>Returned on</th-->
                                <th>Edit</th>
                            </tr>
					    </thead>
					<tbody id="inventory_tbody"></tbody>
				</table>
            </div>
        </div>
    </section>
</div>
<div id="preloaderOverlay" style='display:none;'>
  <div class="preloader">
    <img src="{% static 'images/preloader.gif'%}" width="40" height="40" >
  </div>
</div>
{% endblock content %}

{% block main_js %}
<script src="{% static 'js/reports/jquery.min.js' %}"></script>
<script src="{% static 'js/reports/moment.min.js' %}"></script>
<script src="{% static 'js/webapp/vendor/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'js/jquery.datetimepicker.full.js' %}"></script>


<script type="text/javascript">
$(document).ready(function(){
    olark('api.box.hide');
    function updateInventoryData(){
        $('#inventory').DataTable({
            "ajax": {
                "url": "/reports/inventory/?inventory=true",
                "dataSrc": function(json) {
                    json = json['data']
                    for(var i=0; i<json.length; i++){
                        var returned_on = formatTime(json[i].returned_on)
                        if(returned_on === '1-0-0')
                            returned_on = '-';
                        var employee_alias = json[i].employee_alias;
                        if(employee_alias === "")
                            employee_alias = "-";
                        else
                            employee_alias = employee_alias.split("@")[0]

                        employee_ldap = json[i].employee_ldap.split("@")[0];

                        if(json[i].employee_status){
                            employee_status = 'Active';
                            empColor = 'green';
                            margin = '15px';
                        }
                        else{
                            employee_status = 'Inactive';
                            empColor = 'red';
                            margin = '5px';
                        }

                        if(json[i].device_status){
                            device_status = 'Assigned'
                            deviceColor = 'green'
                        }
                        else{
                            device_status = 'Returned'
                            deviceColor = '#a94442'
                        }

                        json[i][0] = json[i].employee_id;
                        json[i][1] = json[i].employee_name;
                        json[i][2] = employee_ldap;
                        json[i][3] = employee_alias;
                        json[i][4] = json[i].employee_project;
                        json[i][5] = json[i].device_type;
                        json[i][6] = json[i].mac_id;
                        json[i][7] = '<span> '+ employee_status + '<i class="fa fa-circle fa-1"'+
                                        'aria-hidden="true" style="color:'+empColor+';margin-left: '+margin+';"></i></span>';;

                        json[i][8] = '<span style="display: block;width: 76px;"> '+ device_status + '<i class="fa fa-circle fa-1"'+
                                        'aria-hidden="true" style="color:'+deviceColor+';margin-left: 5px;"></i></span>';
                        json[i][9] = formatTime(json[i].issued_on);
                        //json[i][10] = returned_on;
                        json[i][10] = '<a title="Edit" id="'+json[i].id+'" class="edit" href="#"><span class="glyphicon glyphicon-edit"></span></a>';
                    }
                    return json;
                }
            },
            columnDefs: [
                {targets: [ 0 ]},
                {targets: [ 4 ], orderData: [ 4, 0 ]},
                {bSortable: false,targets: [ 2, 3, 6, 10 ]},
                { "width": "7%", "targets": 0 },
                { "width": "10%", "targets": 1 },
                { "width": "8%", "targets": 2 },
                { "width": "6%", "targets": 3 },
                { "width": "10%", "targets": 4 },
                { "width": "10%", "targets": 5 },
                { "width": "10%", "targets": 6 },
                { "width": "11%", "targets": 7 },
                { "width": "11%", "targets": 8 },
                { "width": "8%", "targets": 9 },
                { "width": "4%", "targets": 10 },
            ],
            order: [[ 0, "asc" ]],
            "bDestroy": true,
        });
    }

    updateInventoryData();

    var formatTime = function(unixTimestamp){
        var date = new Date(unixTimestamp*1000);
        var month = date.getMonth() + 1;
        return date.getDate() + "-" + month + "-" + date.getFullYear();
    };

    $("#add_emp").click(function(){
        if($("#emp_entry").is(":visible"))
            $("#add_emp").text("+ Add");
        else
            $("#add_emp").text("Close");

         $("#emp_entry").toggle();
    });

    $(".issued-on").datetimepicker({
          timepicker:false,
          format:'d-m-Y',
          scrollInput:false,
    });


    function validateGcaseEmail(val) {
        domain = val.split("@");
        if(domain.length > 1){
            if(domain[1] != 'google.com')
                return false;
            else
                return true;
        }else{
            return true;
        }
    }

    $('body').on('click', 'a.edit', function(e) {
        e.preventDefault();

        var row = $(this).parent().parent();
        $editingRow = $(this).parent().parent().html();
        var row_id = row.children().eq(10).find('a').attr('id').trim();
        var emp_id = row.children().eq(0).html().trim();
        var emp_name = row.children().eq(1).html().trim();
        var emp_email = row.children().eq(2).html().trim();
        var emp_alais = row.children().eq(3).html().trim();
        if(emp_alais === "-")
            emp_alais = ""

        var emp_proj = row.children().eq(4).html().trim();
        var projOptions = '<option value="Google Portal">Google Portal</option>'+
                        '<option value="Picasso Audits">Picasso Audits</option>'+
                        '<option value="Picasso Builds">Picasso Builds</option>'+
                        '<option value="RLSA">RLSA</option>'+
                        '<option value="Shopping">Shopping</option>'+
                        '<option value="Tag">Tag</option>';
        if(emp_proj === 'Tag')
            projOptions = projOptions.replace('"Tag"', '"Tag" selected');
        else if (emp_proj === 'Shopping')
            projOptions = projOptions.replace('"Shopping"', '"Shopping" selected');
        else if (emp_proj === 'RLSA')
            projOptions = projOptions.replace('"RLSA"', '"RLSA" selected');
        else if (emp_proj === 'Picasso Audits')
            projOptions = projOptions.replace('"Picasso Audits"', '"Picasso Audits" selected');
        else if (emp_proj === 'Picasso Builds')
            projOptions = projOptions.replace('"Picasso Builds"', '"Picasso Builds" selected');
        else if (emp_proj === 'Google Portal')
            projOptions = projOptions.replace('"Google Portal"', '"Google Portal" selected');

        var emp_device = row.children().eq(5).html().trim();
        var emp_mac_id = row.children().eq(6).html().trim();
        var emp_status = row.children().eq(7).text().trim();

        var empStatusOptions = '<option value="Active">Active</option><option value="Inactive">Inactive</option>';
        if(emp_status === 'Active')
            empStatusOptions = empStatusOptions.replace('Active"', 'Active" selected');
        else
            empStatusOptions = empStatusOptions.replace('Inactive"', 'Inactive" selected');

        var dev_status = row.children().eq(8).text().trim();
        var deviceStatusOptions =  '<option value="Assigned">Assigned</option><option value="Returned">Returned</option>';
        if(dev_status === 'Assigned')
            deviceStatusOptions = deviceStatusOptions.replace('Assigned"', 'Assigned" selected');
        else
            deviceStatusOptions = deviceStatusOptions.replace('Returned"', 'Returned" selected');


        var dev_issued_on = row.children().eq(9).html().trim();
        row.children().eq(0).html('<input class="input-sm" value="'+emp_id+'" style="width: 110%;">');
        row.children().eq(1).html('<input class="input-sm" value="'+emp_name+'" style="width: 110%;">');
        row.children().eq(2).html('<input class="input-sm" value="'+emp_email+'" style="width: 110%;">');
        row.children().eq(3).html('<input class="input-sm" value="'+emp_alais+'" style="width: 120%;">');
        row.children().eq(4).html('<select type="text" class="form-control bgicon dropdown" id="project" name="project" style="height:31.5px;margin-bottom: 2px;width: 110%;">'+
                                   projOptions +
                                  '</select>');
        row.children().eq(5).html('<input class="input-sm" value="'+emp_device+'" style="width: 90%;">');
        row.children().eq(6).html('<input class="input-sm" value="'+emp_mac_id+'" style="width: 110%;">');
        row.children().eq(7).html('<select type="text" class="form-control bgicon dropdown" id="employee-status" name="employee-status" style="height:31.5px;margin-bottom: 2px;width: 100%;">'+
                                    empStatusOptions +
                                  '</select>');
        row.children().eq(8).html('<select type="text" class="form-control bgicon dropdown" id="device-type" name="device-type" style="height:31.5px;margin-bottom: 2px;width: 110%;">'+
                                    deviceStatusOptions +
                                 '</select>');
        row.children().eq(9).html('<input class="issued-on input-sm" id="issued-on-din" name="issued-on-din" value="'+dev_issued_on+'" style="width: 100%;">');

        row.children().eq(10).html('<a title="Save" class="save" id="'+row_id+'" href="#" style="color: green;"><span class="glyphicon glyphicon-ok"></span></a>'+
                                    '<a title="Cancel" class="cancel" href="#" style="margin-left: 10px; color: #D83F34;"><span class="glyphicon glyphicon-remove"></span></a>');;

    });

    $('body').on('click', 'a.save', function(e) {
        var row = $(this).parent().parent();
        var row_id = row.children().eq(10).find('a').attr('id');

        var empId = row.children().eq(0).find('input');
        var name = row.children().eq(1).find('input');
        var ldap = row.children().eq(2).find('input');
        var alias = row.children().eq(3).find('input');
        var project = row.children().eq(4).find('select');
        var deviceType = row.children().eq(5).find('input');
        var macId = row.children().eq(6).find('input');
        var employeeStatus = row.children().eq(7).find('select');
        var deviceStatus = row.children().eq(8).find('select');
        var issuedOn = row.children().eq(9).find('input');

        valid = true;
        var employee_id = empId.val().trim()
        if(employee_id === ""){
            empId.addClass('error-box');
            valid = false;
        }else
            empId.removeClass('error-box');

        var employee_name = name.val().trim()
        if(employee_name === ""){
            name.addClass('error-box');
            valid = false;
        }else
            name.removeClass('error-box');

        var employee_ldap = ldap.val().trim()
        if(employee_ldap === ""){
            ldap.addClass('error-box');
            valid = false;
        }else{
            if(validateGcaseEmail(employee_ldap)){
                ldap.removeClass('error-box');
            }else{
                ldap.addClass('error-box');
                valid = false;
            }
        }

        var alias_val = alias.val().trim();
        if(alias_val.length > 0){
            if(validateGcaseEmail(alias_val)){
                alias.removeClass('error-box');
            }else{
                alias.addClass('error-box');
                valid = false;
            };
        };

        var employee_project = project.val().trim()
        if(employee_project === "select project"){
            project.addClass('error-box');
            valid = false;
        }else
            project.removeClass('error-box');

        var employee_deviceType = deviceType.val().trim()
        if(employee_deviceType === ""){
            deviceType.addClass('error-box');
            valid = false;
        }else
            deviceType.removeClass('error-box');

        var employee_macId = macId.val().trim()
        if(employee_macId === ""){
            macId.addClass('error-box');
            valid = false;
        }else
            macId.removeClass('error-box');

        var deviceIssuedOn = issuedOn.val().trim()
        if(deviceIssuedOn === ""){
            issuedOn.addClass('error-box');
            valid = false;
        }else
            issuedOn.removeClass('error-box');

        var jsonData = {
                row_id: row_id,
                emp_id: employee_id,
                name: employee_name,
                ldap: employee_ldap,
                alias: alias_val,
                project: employee_project,
                deviceType: employee_deviceType,
                macId: employee_macId,
                employeeStatus: employeeStatus.val(),
                deviceStatus: deviceStatus.val(),
                issuedOn: deviceIssuedOn
        }

        if(valid){
            $.ajax({
                type: "PUT",
                url: '/reports/inventory/',
                data: JSON.stringify(jsonData),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: function (data) {
                    console.log(true);
                    setTimeout(function(){updateInventoryData();},1000);
                },
                error: function(data){
                    alert("Something went wrong, please try after some time");
                }
            });
        }else
            console.log(false);
    });

    $('body').on('click', 'a.cancel', function(e) {
        e.preventDefault();
        var row = $(this).parent().parent();
        row.html($editingRow);
        delete $editingRow;
    });

    $('body').on('focus',"#issued-on-din", function(){
        $(this).datetimepicker({
          timepicker:false,
          format:'d-m-Y',
          scrollInput:false,
        });
    });


    $("#submit").click(function(e){
        var empId = $("#emp-id");
        var name = $("#name");
        var ldap = $("#ldap");
        var alias = $("#alias");
        var project = $("#project");
        var deviceType = $("#device-type");
        var macId = $("#mac-id");
        var employeeStatus = $("#employee-status");
        var deviceStatus = $("#device-status");
        var issuedOn = $("#issued-on");

        valid = true;
        var employee_id = empId.val().trim()
        if(employee_id === ""){
            empId.addClass('error-box');
            valid = false;
        }else
            empId.removeClass('error-box');

        var employee_name = name.val().trim()
        if(employee_name === ""){
            name.addClass('error-box');
            valid = false;
        }else
            name.removeClass('error-box');

        var employee_ldap = ldap.val().trim()
        if(employee_ldap === ""){
            ldap.addClass('error-box');
            valid = false;
        }else{
            if(validateGcaseEmail(employee_ldap)){
                ldap.removeClass('error-box');
            }else{
                ldap.addClass('error-box');
                valid = false;
            }
        }

        var employee_project = project.val().trim()
        if(employee_project === "select project"){
            project.addClass('error-box');
            valid = false;
        }else
            project.removeClass('error-box');

        var employee_deviceType = deviceType.val().trim()
        if(employee_deviceType === ""){
            deviceType.addClass('error-box');
            valid = false;
        }else
            deviceType.removeClass('error-box');

        var employee_macId = macId.val().trim()
        if(employee_macId === ""){
            macId.addClass('error-box');
            valid = false;
        }else
            macId.removeClass('error-box');

        var deviceIssuedOn = issuedOn.val().trim()
        if(deviceIssuedOn === ""){
            issuedOn.addClass('error-box');
            valid = false;
        }else
            issuedOn.removeClass('error-box');

        var alias = $("#alias").val().trim();
        if(alias.length > 0){
            if(validateGcaseEmail(alias)){
                $("#alias").removeClass('error-box');
            }else{
                $("#alias").addClass('error-box');
                valid = false;
            };
        };

        var jsonData = {
                emp_id: employee_id,
                name: employee_name,
                ldap: employee_ldap,
                alias: alias,
                project: employee_project,
                deviceType: employee_deviceType,
                macId: employee_macId,
                employeeStatus: $("#employee-status").val(),
                deviceStatus: $("#device-status").val(),
                issuedOn: deviceIssuedOn
        }

        if(valid){
            $.ajax({
                type: "POST",
                url: location.href,
                data: JSON.stringify(jsonData),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: function (data) {
                    if(data.type === 'new'){
                        $("#msg-container").html(data.msg);
                        $("#msg-container").css('color', '#3c763d');
                        $(".emp").val('');
                        $("dropdown").find('option:eq(0)').prop('selected', true);
                        setTimeout(function(){updateInventoryData();},1000);

                    }
                    else{
                        $("#msg-container").html(data.msg);
                        $("#msg-container").css('color', '#a94442');
                        $(".emp").val('');
                        $("dropdown").find('option:eq(0)').prop('selected', true);
                    }
                },
                error: function(data){
                    alert("Something went wrong, please try after some time");
                }
            });
        }else
            console.log(false);
    });
});
</script>
{% endblock main_js %}